id: io.github.mudkipworld.pngtuber-remix
runtime: org.freedesktop.Platform
runtime-version: '24.08'
base: org.godotengine.godot.BaseApp
base-version: '4.4'
sdk: org.freedesktop.Sdk
command: pngtuber-remix

finish-args:
  - --share=ipc
  - --socket=x11
  - --socket=pulseaudio
  - --device=all

modules:
  - name: pngtuber-remix
    buildsystem: simple

    sources:
      - type: git
        url: https://github.com/MudkipWorld/PNGTuber-Remix.git
        tag: V1.4
      - type: archive
        url: https://github.com/godotengine/godot/releases/download/4.4.1-stable/Godot_v4.4.1-stable_linux.x86_64.zip
        dest: ./godot
        sha512: ef4e76880a514257175544952c61191106fdef3095b909bafed9fcbeb230c3e5533920a0f3012882dd4bbde83028a67549825794e2d2c3cf76eba7918b71370e
      - type: file
        path: io.github.mudkipworld.pngtuber-remix.metainfo.xml
        dest: ./linux
      - type: file
        path: io.github.mudkipworld.pngtuber-remix.desktop
        dest: ./linux

    build-commands:
      # Prepare export template
      - mkdir -p /app/.local/share/godot/export_templates/4.4.1.stable/
      - ln -s /app/bin/godot-runner /app/.local/share/godot/export_templates/4.4.1.stable/linux_release.x86_64
      # Build
      - mkdir -p /app/share/pngtuber-remix/
      - HOME=/app ./godot/Godot_v4.4.1-stable_linux.x86_64 --headless --path . --export-release "Linux/X11" /app/share/pngtuber-remix/pngtuber-remix
      # Setup stuff
      - mv /app/share/pngtuber-remix/pngtuber-remix /app/bin/pngtuber-remix.bin
      - |
        cat > /app/bin/pngtuber-remix <<EOF
        #!/usr/bin/sh
        pngtuber-remix.bin --path /app/share/pngtuber-remix/
        EOF
      - chmod +x /app/bin/pngtuber-remix
      - mkdir -p /app/share/pngtuber-remix/bin
      - mkdir -p /app/share/pngtuber-remix/godotgif/bin
      - mv /app/share/pngtuber-remix/libgdexample.linux.template_release.x86_64.so /app/share/pngtuber-remix/bin/
      - mv /app/share/pngtuber-remix/libgodotgif.linux.template_release.x86_64.so /app/share/pngtuber-remix/godotgif/bin
      # Desktop stuff
      - install -Dm644 linux/${FLATPAK_ID}.desktop /app/share/applications/${FLATPAK_ID}.desktop
      - install -Dm644 linux/${FLATPAK_ID}.metainfo.xml /app/share/metainfo/${FLATPAK_ID}.metainfo.xml
      - install -Dm644 PicklesSurprised.png /app/share/icons/hicolor/128x128/apps/${FLATPAK_ID}.png
